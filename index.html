<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive 3D Solar System - Realistic Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            background: #000;
            color: #fff;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .controls-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 320px;
            background: rgba(15, 15, 25, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 16px;
            padding: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }

        .controls-panel.collapsed {
            transform: translateX(340px);
        }

        .controls-panel::-webkit-scrollbar {
            width: 6px;
        }

        .controls-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .controls-panel::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 3px;
        }

        .controls-panel h2 {
            font-size: 20px;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }

        .control-group {
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-group h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .control-item {
            margin-bottom: 12px;
        }

        .control-item:last-child {
            margin-bottom: 0;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 13px;
            color: #e2e8f0;
        }

        .control-value {
            font-weight: 600;
            color: #667eea;
            min-width: 45px;
            text-align: right;
            font-size: 12px;
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }
        
        input[type="range"]:disabled::-webkit-slider-thumb {
            background: #555;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #764ba2;
            box-shadow: 0 4px 10px rgba(118, 75, 162, 0.5);
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 6px;
        }

        .button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .button:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .button.secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .button.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(15, 15, 25, 0.9);
            backdrop-filter: blur(10px);
            padding: 12px 18px;
            border-radius: 10px;
            font-size: 12px;
            color: #a0aec0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 300px;
        }

        .planet-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(15, 15, 25, 0.95);
            backdrop-filter: blur(15px);
            padding: 16px;
            border-radius: 14px;
            min-width: 300px;
            max-width: 380px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .planet-info::-webkit-scrollbar {
            width: 6px;
        }

        .planet-info::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .planet-info::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 3px;
        }

        .planet-info h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 20px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .planet-info-section {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .planet-info-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .planet-info-section h4 {
            color: #a0aec0;
            font-size: 12px;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .planet-info p {
            font-size: 13px;
            color: #e2e8f0;
            margin: 4px 0;
            line-height: 1.4;
        }

        .planet-info .fact {
            display: flex;
            align-items: center;
            margin: 6px 0;
            font-size: 13px;
            color: #cbd5e0;
        }

        .planet-info .fact-icon {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            color: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modify-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 12px;
            margin-top: 12px;
        }

        .modify-section h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .modify-control {
            margin-bottom: 10px;
        }

        .modify-control:last-child {
            margin-bottom: 0;
        }

        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="color"] {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: none;
        }

        .reset-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .reset-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #667eea;
        }

        .icon {
            display: inline-block;
            width: 14px;
            height: 14px;
            margin-right: 4px;
            vertical-align: middle;
        }

        .view-toggle {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 15, 25, 0.95);
            backdrop-filter: blur(15px);
            padding: 8px 16px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .view-toggle button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .view-toggle button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
        }

        .view-toggle button:hover:not(.active) {
            background: rgba(255, 255, 255, 0.2);
        }

        .status-indicator {
            position: absolute;
            bottom: 70px;
            left: 20px;
            background: rgba(15, 15, 25, 0.9);
            backdrop-filter: blur(10px);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 12px;
            color: #a0aec0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }

        .status-indicator.active {
            display: block;
        }

        .toggle-panel {
            position: absolute;
            top: 20px;
            right: 360px;
            background: rgba(15, 15, 25, 0.95);
            backdrop-filter: blur(15px);
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-panel:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .toggle-panel.panel-hidden {
            right: 20px;
        }

        .help-text {
            position: absolute;
            top: 60px;
            left: 20px;
            background: rgba(15, 15, 25, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 11px;
            color: #a0aec0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 250px;
            line-height: 1.4;
        }

        /* Gemini Feature Styles */
        #gemini-response {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            min-height: 50px;
            font-style: italic;
            color: #cbd5e0;
        }

        .gemini-loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Quick Nav Grid */
        #nav-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            transition: background 0.2s ease;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .nav-icon {
            font-size: 24px;
        }

        .nav-name {
            font-size: 10px;
            margin-top: 4px;
            text-align: center;
        }


        @media (max-width: 768px) {
            .controls-panel {
                width: 280px;
                right: 10px;
                top: 10px;
                padding: 14px;
            }

            .info-panel {
                bottom: 10px;
                left: 10px;
                font-size: 11px;
                max-width: 250px;
            }

            .planet-info {
                left: 10px;
                top: 10px;
                min-width: 280px;
                max-width: calc(100vw - 20px);
            }

            .view-toggle {
                top: 10px;
                padding: 6px 12px;
            }

            .view-toggle button {
                padding: 4px 10px;
                font-size: 11px;
            }

            .toggle-panel {
                right: 300px;
            }

            .help-text {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="canvas-container">
        <div class="loading">Loading Solar System...</div>
    </div>

    <div class="view-toggle">
        <button id="systemViewBtn" class="active">System View</button>
        <button id="planetViewBtn">Planet View</button>
    </div>

    <div class="toggle-panel" id="togglePanel">
        <span class="icon">☰</span>
    </div>

    <div class="controls-panel" id="controlsPanel">
        <h2>Solar System Controls</h2>

        <div class="control-group">
            <h3>Simulation Mode</h3>
            <div class="view-toggle" style="position: relative; left: 0; transform: none; margin-bottom: 10px; justify-content: center;">
                <button id="artisticModeBtn" class="active">Artistic</button>
                <button id="realisticModeBtn">Realistic</button>
            </div>
        </div>

        <div class="control-group" id="quick-nav-group">
            <h3>Quick Navigation</h3>
            <div id="nav-buttons"></div>
        </div>

        <div class="control-group">
            <h3>Time & Animation</h3>
            <div class="control-item">
                <div class="control-label">
                    <span>Time Scale</span>
                    <span class="control-value" id="timeScaleValue">1.0x</span>
                </div>
                <input type="range" id="timeScale" min="0" max="10" step="0.1" value="1">
            </div>
            <div class="control-item">
                <div class="control-label">
                    <span>Orbit Speed</span>
                    <span class="control-value" id="orbitSpeedValue">1.0x</span>
                </div>
                <input type="range" id="orbitSpeed" min="0" max="5" step="0.1" value="1">
            </div>
            <div class="control-item">
                <div class="control-label">
                    <span>Rotation Speed</span>
                    <span class="control-value" id="rotationSpeedValue">1.0x</span>
                </div>
                <input type="range" id="rotationSpeed" min="0" max="5" step="0.1" value="1">
            </div>
        </div>

        <div class="control-group" id="visual-settings-group">
            <h3>Visual Settings</h3>
            <div class="control-item">
                <div class="control-label">
                    <span>Planet Size</span>
                    <span class="control-value" id="planetSizeValue">1.0x</span>
                </div>
                <input type="range" id="planetSize" min="0.5" max="3" step="0.1" value="1">
            </div>
            <div class="control-item">
                <div class="control-label">
                    <span>Orbit Size</span>
                    <span class="control-value" id="orbitSizeValue">1.0x</span>
                </div>
                <input type="range" id="orbitSize" min="0.5" max="2" step="0.1" value="1">
            </div>
            <div class="control-item">
                <div class="control-label">
                    <span>Camera Distance</span>
                    <span class="control-value" id="cameraDistanceValue">100</span>
                </div>
                <input type="range" id="cameraDistance" min="25" max="300" step="5" value="100">
            </div>
        </div>

        <div class="control-group">
            <h3>Display Options</h3>
            <div class="control-item">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="showOrbits" checked>
                    <label for="showOrbits">Show Orbits</label>
                </div>
            </div>
            <div class="control-item">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="showLabels" checked>
                    <label for="showLabels">Show Labels</label>
                </div>
            </div>
            <div class="control-item">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="showStars" checked>
                    <label for="showStars">Show Stars</label>
                </div>
            </div>
            <div class="control-item">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="realisticLighting" checked>
                    <label for="realisticLighting">Realistic Lighting</label>
                </div>
            </div>
        </div>

        <div class="control-group">
            <h3>Lighting</h3>
            <div class="control-item">
                <div class="control-label">
                    <span>Sun Intensity</span>
                    <span class="control-value" id="sunIntensityValue">2.0</span>
                </div>
                <input type="range" id="sunIntensity" min="0" max="5" step="0.1" value="2">
            </div>
            <div class="control-item">
                <div class="control-label">
                    <span>Ambient Light</span>
                    <span class="control-value" id="ambientLightValue">0.05</span>
                </div>
                <input type="range" id="ambientLight" min="0" max="0.3" step="0.01" value="0.05">
            </div>
        </div>

        <div class="control-group">
            <h3>Camera Actions</h3>
            <button class="button" id="focusOnSun">Focus on Sun</button>
            <button class="button secondary" id="resetCamera">Reset Camera</button>
        </div>
    </div>

    <div class="info-panel">
        <p><strong>Controls:</strong> Left click + drag to rotate • Right click + drag to pan • Scroll to zoom • Click planets for info</p>
    </div>

    <div class="help-text">
        <p><strong>Tips:</strong> Use Planet View to follow planets closely • Adjust lighting for realistic day/night • Camera can zoom to 25 units</p>
    </div>

    <div class="status-indicator" id="statusIndicator">
        <span id="statusText">Solar System View</span>
    </div>

    <div class="planet-info" id="planetInfo">
        <h3 id="planetName"></h3>
        
        <div class="planet-info-section">
            <h4>Overview</h4>
            <p id="planetDescription"></p>
        </div>
        
        <div class="planet-info-section">
            <h4>Current Situation</h4>
            <div id="planetSituation"></div>
        </div>
        
        <div class="planet-info-section">
            <h4>Key Facts</h4>
            <div id="planetFacts"></div>
        </div>
        
        <div class="planet-info-section">
            <h4>Physical Properties</h4>
            <div id="planetProperties"></div>
        </div>

        <!-- Gemini API Section -->
        <div class="planet-info-section" id="gemini-insights">
            <h4>Cosmic Insights ✨</h4>
            <button class="button" id="generateFactBtn">Generate Fun Fact ✨</button>
            <button class="button secondary" id="generateLogBtn">Generate Mission Log ✨</button>
            <div id="gemini-response">Click a button to learn more!</div>
        </div>
        
        <div class="modify-section">
            <h4>
                <span class="icon">⚙️</span>
                Modify Planet
            </h4>
            
            <div class="modify-control">
                <div class="control-label">
                    <span>Size</span>
                    <span class="control-value" id="modifySizeValue">1.0x</span>
                </div>
                <input type="range" id="modifySize" min="0.5" max="3" step="0.1" value="1">
            </div>
            
            <div class="modify-control">
                <div class="control-label">
                    <span>Rotation Speed</span>
                    <span class="control-value" id="modifyRotationValue">1.0x</span>
                </div>
                <input type="range" id="modifyRotation" min="0" max="5" step="0.1" value="1">
            </div>
            
            <div class="modify-control" id="orbitSpeedControl">
                <div class="control-label">
                    <span>Orbit Speed</span>
                    <span class="control-value" id="modifyOrbitValue">1.0x</span>
                </div>
                <input type="range" id="modifyOrbit" min="0" max="5" step="0.1" value="1">
            </div>
            
            <div class="modify-control">
                <div class="control-label">
                    <span>Color</span>
                </div>
                <div class="color-picker-wrapper">
                    <input type="color" id="modifyColor" value="#ffffff">
                    <span id="colorValue">#ffffff</span>
                </div>
            </div>
            
            <button class="reset-button" id="resetPlanet">Reset to Default</button>
        </div>
    </div>

    <script type="module" src="./main.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            // Scene setup
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 80000);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Remove loading message
            document.querySelector('.loading').style.display = 'none';

            // Controls
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 0.01;
            controls.maxDistance = 40000;
            controls.enablePan = true;

            // Enhanced lighting setup
            const sunLight = new THREE.PointLight(0xffffff, 2, 0, 2);
            sunLight.position.set(0, 0, 0);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 4096;
            sunLight.shadow.mapSize.height = 4096;
            sunLight.shadow.camera.near = 0.5;
            sunLight.shadow.camera.far = 5000; // REALISM FIX: Extend shadow camera range
            scene.add(sunLight);

            // Very minimal ambient light for realistic space
            const ambientLight = new THREE.AmbientLight(0x0a0a0a, 0.05);
            scene.add(ambientLight);

            // Enhanced star field
            const starsGeometry = new THREE.BufferGeometry();
            const starsMaterial = new THREE.PointsMaterial({ 
                color: 0xffffff, 
                size: 20, // REALISM: Make stars larger to be visible from afar
                transparent: true,
                opacity: 0.8
            });
            const starsVertices = [];
            for (let i = 0; i < 40000; i++) {
                const x = (Math.random() - 0.5) * 80000;
                const y = (Math.random() - 0.5) * 80000;
                const z = (Math.random() - 0.5) * 80000;
                starsVertices.push(x, y, z);
            }
            starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starsVertices, 3));
            const stars = new THREE.Points(starsGeometry, starsMaterial);
            scene.add(stars);

            // Grid
            const gridHelper = new THREE.GridHelper(500, 50, 0x444444, 0x222222);
            gridHelper.visible = false;
            scene.add(gridHelper);

            // Planet data with detailed information
            const planetData = window.planetData;

            // Create planets
            const planets = [];
            const orbits = [];
            const labels = [];
            const planetModifiers = {};
            const allCelestialBodies = []; // For raycasting
            const moonObjects = []; // For quick navigation

            // REALISM SCALES
            const REALISTIC_RADIUS_SCALE = 1 / 10000; // 1 unit = 10,000 km
            const KM_PER_AU = 149.6e6;
            const REALISTIC_DISTANCE_SCALE = 1500; // 1 AU = 1500 units
            const KM_TO_UNIT_SCALE = REALISTIC_DISTANCE_SCALE / KM_PER_AU; // Scale for moon distances

            let sunPhongMaterial; // To store original sun material

            planetData.forEach((data, index) => {
                // Create planet with enhanced material
                const geometry = new THREE.SphereGeometry(data.radius, 64, 64);
                const material = new THREE.MeshPhongMaterial({ 
                    color: data.color,
                    emissive: data.emissive || 0x000000,
                    emissiveIntensity: data.emissiveIntensity || 0,
                    shininess: 30,
                    specular: 0x222222
                });
                if (data.name === 'Sun') sunPhongMaterial = material;

                const planet = new THREE.Mesh(geometry, material);
                
                if (data.name !== 'Sun') {
                    planet.castShadow = true;
                } else {
                    planet.castShadow = false;
                }
                
                planet.receiveShadow = true;
                planet.userData = { ...data, index, isPlanet: true };
                
                // Create orbit
                if (data.distance > 0) {
                    const orbitGeometry = new THREE.RingGeometry(data.distance - 0.2, data.distance + 0.2, 128);
                    const orbitMaterial = new THREE.MeshBasicMaterial({ 
                        color: data.color, 
                        side: THREE.DoubleSide,
                        transparent: true,
                        opacity: 0.3
                    });
                    const orbit = new THREE.Mesh(orbitGeometry, orbitMaterial);
                    orbit.rotation.x = -Math.PI / 2;
                    scene.add(orbit);
                    orbits.push(orbit);
                }
                
                // Create label
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = 256;
                canvas.height = 64;
                context.font = 'Bold 48px Arial';
                context.fillStyle = 'white';
                context.textAlign = 'center';
                context.fillText(data.name, 128, 48);
                
                const texture = new THREE.CanvasTexture(canvas);
                const spriteMaterial = new THREE.SpriteMaterial({ map: texture, transparent: true });
                const sprite = new THREE.Sprite(spriteMaterial);
                sprite.scale.set(10, 2.5, 1);
                
                planets.push(planet);
                labels.push(sprite);
                scene.add(planet);
                scene.add(sprite);
                allCelestialBodies.push(planet);
                
                // Initialize modifiers
                planetModifiers[index] = {
                    size: 1,
                    rotationSpeed: 1,
                    orbitSpeed: 1,
                    color: '#' + data.color.toString(16).padStart(6, '0')
                };

                // REALISM: Add Moons
                if (data.moons) {
                    data.moons.forEach(moonData => {
                        const moonGeom = new THREE.SphereGeometry(moonData.radius, 32, 32);
                        const moonMat = new THREE.MeshPhongMaterial({ color: moonData.color });
                        const moon = new THREE.Mesh(moonGeom, moonMat);
                        moon.castShadow = true;
                        moon.receiveShadow = true;
                        moon.userData = { ...moonData, isPlanet: false, parentPlanet: planet };
                        
                        // Add moon orbit
                        const moonOrbitGeom = new THREE.RingGeometry(moonData.distance - 0.05, moonData.distance + 0.05, 64);
                        const moonOrbitMat = new THREE.MeshBasicMaterial({ color: 0x666666, side: THREE.DoubleSide, transparent: true, opacity: 0.3 });
                        const moonOrbit = new THREE.Mesh(moonOrbitGeom, moonOrbitMat);
                        moonOrbit.rotation.x = -Math.PI / 2;
                        
                        planet.add(moonOrbit); // Add orbit to the planet
                        planet.add(moon); // Add moon as a child of the planet
                        allCelestialBodies.push(moon);
                        moonObjects.push(moon);
                    });
                }
            });

            // Saturn's rings
            const ringGeometry = new THREE.RingGeometry(9, 13, 64);
            const ringMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xffcc99, 
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.8
            });
            const rings = new THREE.Mesh(ringGeometry, ringMaterial);
            rings.rotation.x = -Math.PI / 2.5;
            planets[6].add(rings);

            // Camera position
            camera.position.set(80, 60, 120);
            camera.lookAt(0, 0, 0);

            // Control variables
            let timeScale = 1;
            let orbitSpeedMultiplier = 1;
            let rotationSpeedMultiplier = 1;
            let planetSizeMultiplier = 1;
            let orbitSizeMultiplier = 1;
            let showOrbits = true;
            let showLabels = true;
            let showStars = true;
            let realisticLighting = true;
            let sunIntensity = 2;
            let ambientLightIntensity = 0.05;
            let selectedObject = null; // Can be planet or moon
            let currentView = 'system';
            let followingObject = null;
            let isGeminiRunning = false;
            let currentMode = 'artistic';
            let isAnimatingCamera = false;
            let lastTargetPosition = new THREE.Vector3();
            let mouseDownPos = new THREE.Vector2();

            // Panel toggle
            const togglePanel = document.getElementById('togglePanel');
            const controlsPanel = document.getElementById('controlsPanel');
            
            togglePanel.addEventListener('click', () => {
                controlsPanel.classList.toggle('collapsed');
                togglePanel.classList.toggle('panel-hidden');
            });

            // View toggle
            const systemViewBtn = document.getElementById('systemViewBtn');
            const planetViewBtn = document.getElementById('planetViewBtn');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');

            systemViewBtn.addEventListener('click', () => {
                currentView = 'system';
                followingObject = null;
                systemViewBtn.classList.add('active');
                planetViewBtn.classList.remove('active');
                statusIndicator.classList.remove('active');
                controls.autoRotate = false; 
                resetCameraView();
            });

            planetViewBtn.addEventListener('click', () => {
                if (selectedObject !== null) {
                    currentView = 'planet';
                    followingObject = selectedObject;
                    planetViewBtn.classList.add('active');
                    systemViewBtn.classList.remove('active');
                    statusIndicator.classList.add('active');
                    updateStatusText();
                    focusOnObject(selectedObject);
                }
            });

            function updateStatusText() {
                if (followingObject !== null) {
                    const objectName = followingObject.userData.name;
                    statusText.textContent = `Following ${objectName}`;
                }
            }

            // Control handlers
            document.getElementById('timeScale').addEventListener('input', (e) => {
                timeScale = parseFloat(e.target.value);
                document.getElementById('timeScaleValue').textContent = timeScale.toFixed(1) + 'x';
            });

            document.getElementById('orbitSpeed').addEventListener('input', (e) => {
                orbitSpeedMultiplier = parseFloat(e.target.value);
                document.getElementById('orbitSpeedValue').textContent = orbitSpeedMultiplier.toFixed(1) + 'x';
            });

            document.getElementById('rotationSpeed').addEventListener('input', (e) => {
                rotationSpeedMultiplier = parseFloat(e.target.value);
                document.getElementById('rotationSpeedValue').textContent = rotationSpeedMultiplier.toFixed(1) + 'x';
            });

            document.getElementById('planetSize').addEventListener('input', (e) => {
                planetSizeMultiplier = parseFloat(e.target.value);
                document.getElementById('planetSizeValue').textContent = planetSizeMultiplier.toFixed(1) + 'x';
                updatePlanetSizes();
            });

            document.getElementById('orbitSize').addEventListener('input', (e) => {
                orbitSizeMultiplier = parseFloat(e.target.value);
                document.getElementById('orbitSizeValue').textContent = orbitSizeMultiplier.toFixed(1) + 'x';
                updateOrbitSizes();
            });

            document.getElementById('cameraDistance').addEventListener('input', (e) => {
                const distance = parseFloat(e.target.value);
                document.getElementById('cameraDistanceValue').textContent = distance;
                if (currentView === 'system') {
                    const direction = camera.position.clone().normalize();
                    camera.position.copy(direction.multiplyScalar(distance));
                }
            });

            document.getElementById('showOrbits').addEventListener('change', (e) => {
                showOrbits = e.target.checked;
                orbits.forEach(orbit => orbit.visible = showOrbits);
            });

            document.getElementById('showLabels').addEventListener('change', (e) => {
                showLabels = e.target.checked;
                labels.forEach(label => label.visible = showLabels);
            });

            document.getElementById('showStars').addEventListener('change', (e) => {
                showStars = e.target.checked;
                stars.visible = showStars;
            });

            document.getElementById('realisticLighting').addEventListener('change', (e) => {
                realisticLighting = e.target.checked;
                if (realisticLighting) {
                    ambientLight.intensity = 0.05;
                    document.getElementById('ambientLight').value = 0.05;
                    document.getElementById('ambientLightValue').textContent = '0.05';
                } else {
                    ambientLight.intensity = 0.2;
                    document.getElementById('ambientLight').value = 0.2;
                    document.getElementById('ambientLightValue').textContent = '0.20';
                }
            });

            document.getElementById('sunIntensity').addEventListener('input', (e) => {
                sunIntensity = parseFloat(e.target.value);
                document.getElementById('sunIntensityValue').textContent = sunIntensity.toFixed(1);
                if (currentMode === 'artistic') {
                    sunLight.intensity = sunIntensity;
                }
            });

            document.getElementById('ambientLight').addEventListener('input', (e) => {
                ambientLightIntensity = parseFloat(e.target.value);
                document.getElementById('ambientLightValue').textContent = ambientLightIntensity.toFixed(2);
                ambientLight.intensity = ambientLightIntensity;
            });

            // Camera actions
            document.getElementById('focusOnSun').addEventListener('click', () => {
                focusOnObject(planets[0]);
            });

            document.getElementById('resetCamera').addEventListener('click', resetCameraView);

            function focusOnObject(object) {
                const objectData = object.userData;
                const radius = (currentMode === 'realistic' && objectData.realisticRadiusKM) ? objectData.realisticRadiusKM * REALISTIC_RADIUS_SCALE : objectData.radius;
                const sizeModifier = (objectData.isPlanet && currentMode === 'artistic') ? planetModifiers[objectData.index].size : 1;
                
                let distance = radius * (currentMode === 'artistic' ? planetSizeMultiplier : 1) * sizeModifier * 4;
                if(currentMode === 'realistic') {
                    distance = Math.max(radius * 10, 50); // Ensure a minimum distance in realistic mode
                }

                const worldPosition = new THREE.Vector3();
                object.getWorldPosition(worldPosition);
                
                const offset = new THREE.Vector3(distance, distance * 0.6, distance);
                const cameraPosition = worldPosition.clone().add(offset);
                
                animateCamera(cameraPosition, worldPosition);
            }

            function resetCameraView() {
                let distance = parseFloat(document.getElementById('cameraDistance').value);
                if(currentMode === 'realistic') distance = 3000;

                const cameraPosition = new THREE.Vector3(distance, distance * 0.75, distance);
                animateCamera(cameraPosition, new THREE.Vector3(0, 0, 0));
            }

            function animateCamera(targetPosition, lookAtPosition) {
                isAnimatingCamera = true;
                const startPosition = camera.position.clone();
                const startTarget = controls.target.clone();
                
                const distance = startPosition.distanceTo(targetPosition);
                const duration = Math.max(1500, distance / 5);
                
                const startTime = Date.now();

                function updateCamera() {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const easeProgress = 1 - Math.pow(1 - progress, 3);

                    camera.position.lerpVectors(startPosition, targetPosition, easeProgress);
                    controls.target.lerpVectors(startTarget, lookAtPosition, easeProgress);
                    controls.update();

                    if (progress < 1) {
                        requestAnimationFrame(updateCamera);
                    } else {
                        isAnimatingCamera = false;
                        lastTargetPosition.copy(lookAtPosition);
                    }
                }

                updateCamera();
            }

            // Planet modification controls
            document.getElementById('modifySize').addEventListener('input', (e) => {
                if (selectedObject && selectedObject.userData.isPlanet) {
                    const value = parseFloat(e.target.value);
                    planetModifiers[selectedObject.userData.index].size = value;
                    document.getElementById('modifySizeValue').textContent = value.toFixed(1) + 'x';
                    updateSelectedPlanet();
                }
            });

            document.getElementById('modifyRotation').addEventListener('input', (e) => {
                if (selectedObject && selectedObject.userData.isPlanet) {
                    const value = parseFloat(e.target.value);
                    planetModifiers[selectedObject.userData.index].rotationSpeed = value;
                    document.getElementById('modifyRotationValue').textContent = value.toFixed(1) + 'x';
                }
            });

            document.getElementById('modifyOrbit').addEventListener('input', (e) => {
                if (selectedObject && selectedObject.userData.isPlanet) {
                    const value = parseFloat(e.target.value);
                    planetModifiers[selectedObject.userData.index].orbitSpeed = value;
                    document.getElementById('modifyOrbitValue').textContent = value.toFixed(1) + 'x';
                }
            });

            document.getElementById('modifyColor').addEventListener('input', (e) => {
                if (selectedObject && selectedObject.userData.isPlanet) {
                    const color = e.target.value;
                    planetModifiers[selectedObject.userData.index].color = color;
                    document.getElementById('colorValue').textContent = color;
                    updateSelectedPlanetColor();
                }
            });

            document.getElementById('resetPlanet').addEventListener('click', () => {
                if (selectedObject && selectedObject.userData.isPlanet) {
                    resetPlanet(selectedObject.userData.index);
                }
            });

            // Update functions
            function updatePlanetSizes() {
                planets.forEach((planet, index) => {
                    const modifier = planetModifiers[index].size;
                    planet.scale.setScalar(planetSizeMultiplier * modifier);
                });
            }

            function updateOrbitSizes() {
                orbits.forEach((orbit, index) => {
                    const originalDistance = planetData[index + 1].distance;
                    const newDistance = originalDistance * orbitSizeMultiplier;
                    orbit.geometry.dispose();
                    orbit.geometry = new THREE.RingGeometry(newDistance - 0.2, newDistance + 0.2, 128);
                });
            }

            function updateSelectedPlanet() {
                if (selectedObject && selectedObject.userData.isPlanet) {
                    const planet = selectedObject;
                    const modifier = planetModifiers[planet.userData.index].size;
                    planet.scale.setScalar(planetSizeMultiplier * modifier);
                }
            }

            function updateSelectedPlanetColor() {
                if (selectedObject && selectedObject.userData.isPlanet) {
                    const planet = selectedObject;
                    const color = planetModifiers[planet.userData.index].color;
                    planet.material.color.set(color);

                    if (planet.userData.index === 0) {
                        planet.material.emissive.set(color);
                    }
                }
            }

            function resetPlanet(index) {
                const planet = planets[index];
                const data = planetData[index];
                
                planetModifiers[index] = {
                    size: 1,
                    rotationSpeed: 1,
                    orbitSpeed: 1,
                    color: '#' + data.color.toString(16).padStart(6, '0')
                };
                
                document.getElementById('modifySize').value = 1;
                document.getElementById('modifySizeValue').textContent = '1.0x';
                document.getElementById('modifyRotation').value = 1;
                document.getElementById('modifyRotationValue').textContent = '1.0x';
                document.getElementById('modifyOrbit').value = 1;
                document.getElementById('modifyOrbitValue').textContent = '1.0x';
                document.getElementById('modifyColor').value = '#' + data.color.toString(16).padStart(6, '0');
                document.getElementById('colorValue').textContent = '#' + data.color.toString(16).padStart(6, '0');
                
                planet.scale.setScalar(planetSizeMultiplier);
                planet.material.color.set(data.color);
                if (index === 0) {
                     planet.material.emissive.set(data.color);
                }
            }

            // Raycaster for planet selection
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();

            function onMouseDown(event) {
                mouseDownPos.x = event.clientX;
                mouseDownPos.y = event.clientY;
            }

            function onMouseUp(event) {
                const deltaX = Math.abs(event.clientX - mouseDownPos.x);
                const deltaY = Math.abs(event.clientY - mouseDownPos.y);
                const dragThreshold = 5;

                if (deltaX > dragThreshold || deltaY > dragThreshold) {
                    return; // It was a drag, do nothing.
                }

                if (event.target.closest('.controls-panel') || 
                    event.target.closest('.planet-info') || 
                    event.target.closest('.view-toggle') ||
                    event.target.closest('.toggle-panel') ||
                    event.target.closest('.info-panel') ||
                    event.target.closest('.help-text') ||
                    event.target.closest('.status-indicator')) {
                    return;
                }

                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(allCelestialBodies);

                if (intersects.length > 0) {
                    const object = intersects[0].object;
                    selectedObject = object;
                    showObjectInfo(object.userData);
                    
                    if (currentView === 'planet') {
                        followingObject = selectedObject;
                        updateStatusText();
                        focusOnObject(selectedObject);
                    }
                } else {
                    hidePlanetInfo();
                    selectedObject = null;
                }
            }

            function showObjectInfo(data) {
                const infoPanel = document.getElementById('planetInfo');
                const nameElement = document.getElementById('planetName');
                const descriptionElement = document.getElementById('planetDescription');
                const factsElement = document.getElementById('planetFacts');
                const propertiesElement = document.getElementById('planetProperties');
                const orbitSpeedControl = document.getElementById('orbitSpeedControl');
                const modifySection = document.querySelector('.modify-section');

                nameElement.textContent = data.name;
                descriptionElement.textContent = data.description || `A moon of ${data.parentPlanet.userData.name}.`;
                
                document.getElementById('planetSituation').innerHTML = '';
                document.getElementById('gemini-response').innerHTML = 'Click a button to learn more!';
                
                factsElement.innerHTML = '';
                if (data.facts) {
                    data.facts.forEach(fact => {
                        const factDiv = document.createElement('div');
                        factDiv.className = 'fact';
                        factDiv.innerHTML = `<span class="fact-icon">${fact.icon}</span> ${fact.text}`;
                        factsElement.appendChild(factDiv);
                    });
                }
                
                propertiesElement.innerHTML = '';
                 if (data.properties) {
                    data.properties.forEach(prop => {
                        const propDiv = document.createElement('p');
                        propDiv.innerHTML = `<strong>${prop.label}:</strong> ${prop.value}`;
                        propertiesElement.appendChild(propDiv);
                    });
                }
                
                if (data.isPlanet) {
                    modifySection.style.display = 'block';
                    if (data.name === 'Sun') {
                        orbitSpeedControl.style.display = 'none';
                    } else {
                        orbitSpeedControl.style.display = 'block';
                    }
                    const modifier = planetModifiers[data.index];
                    document.getElementById('modifySize').value = modifier.size;
                    document.getElementById('modifySizeValue').textContent = modifier.size.toFixed(1) + 'x';
                    document.getElementById('modifyRotation').value = modifier.rotationSpeed;
                    document.getElementById('modifyRotationValue').textContent = modifier.rotationSpeed.toFixed(1) + 'x';
                    document.getElementById('modifyOrbit').value = modifier.orbitSpeed;
                    document.getElementById('modifyOrbitValue').textContent = modifier.orbitSpeed.toFixed(1) + 'x';
                    document.getElementById('modifyColor').value = modifier.color;
                    document.getElementById('colorValue').textContent = modifier.color;
                } else {
                    modifySection.style.display = 'none';
                }
                
                infoPanel.style.display = 'block';
            }

            function hidePlanetInfo() {
                document.getElementById('planetInfo').style.display = 'none';
            }
            
            function updateLiveInfo() {
                if (selectedObject === null) return;
                
                const situationElement = document.getElementById('planetSituation');
                if (!situationElement) return;

                const data = selectedObject.userData;
                let situationText = '';
                
                const worldPosition = new THREE.Vector3();
                selectedObject.getWorldPosition(worldPosition);

                if (data.name === 'Sun') {
                    situationText = 'The Sun illuminates all planets in the solar system.';
                } else {
                    const sunPosition = new THREE.Vector3(); 
                    const objectToSun = new THREE.Vector3().subVectors(sunPosition, worldPosition).normalize();
                    const objectToCamera = new THREE.Vector3().subVectors(camera.position, worldPosition).normalize();
                    const angle = objectToSun.angleTo(objectToCamera) * (180 / Math.PI);

                    if (angle < 90) {
                         situationText = `Viewing the day side (${angle.toFixed(0)}°)`;
                    } else {
                         situationText = `Viewing the night side (${angle.toFixed(0)}°)`;
                    }
                }
                situationElement.innerHTML = `<p><strong>Viewpoint:</strong> ${situationText}</p>`;
            }


            window.addEventListener('mousedown', onMouseDown);
            window.addEventListener('mouseup', onMouseUp);

            // --- Gemini API Integration ---
            const generateFactBtn = document.getElementById('generateFactBtn');
            const generateLogBtn = document.getElementById('generateLogBtn');
            const geminiResponseEl = document.getElementById('gemini-response');

            async function callGeminiAPI(prompt, maxRetries = 3) {
                isGeminiRunning = true;
                setGeminiButtonsDisabled(true);
                geminiResponseEl.innerHTML = '<div class="gemini-loader"></div>';

                const apiKey = ""; // Will be provided by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }]
                };

                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`API call failed with status: ${response.status}`);
                        }

                        const result = await response.json();
                        
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const text = result.candidates[0].content.parts[0].text;
                            geminiResponseEl.innerText = text;
                            isGeminiRunning = false;
                            setGeminiButtonsDisabled(false);
                            return;
                        } else {
                             throw new Error("Invalid response structure from API.");
                        }

                    } catch (error) {
                        if (i === maxRetries - 1) {
                            geminiResponseEl.innerText = 'Error: Could not get a response. Please try again later.';
                            console.error("Gemini API Error:", error);
                            isGeminiRunning = false;
                            setGeminiButtonsDisabled(false);
                            return;
                        }
                        await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
                    }
                }
            }

            function setGeminiButtonsDisabled(disabled) {
                generateFactBtn.disabled = disabled;
                generateLogBtn.disabled = disabled;
            }

            generateFactBtn.addEventListener('click', () => {
                if (selectedObject !== null && !isGeminiRunning) {
                    const objectName = selectedObject.userData.name;
                    const prompt = `You are an expert astronomer. Tell me one surprising or little-known fun fact about the celestial body ${objectName}. Make it concise and engaging for a general audience.`;
                    callGeminiAPI(prompt);
                }
            });

            generateLogBtn.addEventListener('click', () => {
                if (selectedObject !== null && !isGeminiRunning) {
                    const objectName = selectedObject.userData.name;
                    const prompt = `Write a creative, short "mission log" entry (about 50-75 words) from an astronaut exploring ${objectName}. Capture the feeling of being there, mentioning one of its key characteristics.`;
                    callGeminiAPI(prompt);
                }
            });


            // Animation loop
            let time = 0;
            const clock = new THREE.Clock();

            function animate() {
                requestAnimationFrame(animate);

                const delta = clock.getDelta();
                time += delta * timeScale;

                // Update planets and their moons
                planets.forEach((planet, index) => {
                    const data = planetData[index];
                    const modifier = planetModifiers[index];
                    
                    planet.rotation.y += data.rotationSpeed * rotationSpeedMultiplier * modifier.rotationSpeed * timeScale * delta * 50;
                    
                    if (data.distance > 0) {
                        const distance = (currentMode === 'realistic') ? data.realisticDistanceAU * REALISTIC_DISTANCE_SCALE : data.distance * orbitSizeMultiplier;
                        const angle = time * data.orbitSpeed * orbitSpeedMultiplier * modifier.orbitSpeed;
                        planet.position.x = Math.cos(angle) * distance;
                        planet.position.z = Math.sin(angle) * distance;
                    }
                    
                    labels[index].position.copy(planet.position);
                    labels[index].position.y += data.radius * planetSizeMultiplier * modifier.size + 4;
                    
                    const distance = camera.position.distanceTo(labels[index].position);
                    const labelScale = distance / 15;
                    labels[index].scale.set(labelScale, labelScale * 0.25, 1);

                    // Animate moons
                    if(data.moons) {
                        planet.children.forEach(child => {
                            if (child.userData.isPlanet === false) { // It's a moon
                                const moonData = child.userData;
                                const distance = (currentMode === 'realistic') ? moonData.realisticDistanceKM * KM_TO_UNIT_SCALE : moonData.distance;
                                const angle = time * moonData.orbitSpeed * orbitSpeedMultiplier;
                                child.position.x = Math.cos(angle) * distance;
                                child.position.z = Math.sin(angle) * distance;
                            }
                        });
                    }
                });

                if (currentView === 'planet' && followingObject !== null && !isAnimatingCamera) {
                    const newTargetPosition = new THREE.Vector3();
                    followingObject.getWorldPosition(newTargetPosition);

                    if (!lastTargetPosition.equals(new THREE.Vector3(0,0,0))) {
                        const deltaMove = new THREE.Vector3().subVectors(newTargetPosition, lastTargetPosition);
                        camera.position.add(deltaMove);
                    }
                    
                    controls.target.copy(newTargetPosition);
                    lastTargetPosition.copy(newTargetPosition);
                } else if (currentView !== 'planet' || isAnimatingCamera) {
                    lastTargetPosition.set(0,0,0);
                }
                
                if (document.getElementById('planetInfo').style.display === 'block') {
                    updateLiveInfo();
                }

                // CAMERA IMPROVEMENT: Dynamic camera speed
                if (controls.enabled) {
                    const distanceToTarget = camera.position.distanceTo(controls.target);
                    controls.zoomSpeed = Math.max(0.1, distanceToTarget / 200);
                    controls.panSpeed = Math.max(0.1, distanceToTarget / 200);
                }

                controls.update();
                renderer.render(scene, camera);
            }

            // Handle window resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case '1':
                        systemViewBtn.click();
                        break;
                    case '2':
                        if (selectedObject !== null) {
                            planetViewBtn.click();
                        }
                        break;
                    case 'r':
                        resetCameraView();
                        break;
                    case 's':
                        document.getElementById('focusOnSun').click();
                        break;
                    case ' ':
                        e.preventDefault();
                        const timeScaleSlider = document.getElementById('timeScale');
                        timeScaleSlider.value = timeScaleSlider.value === '0' ? '1' : '0';
                        timeScaleSlider.dispatchEvent(new Event('input'));
                        break;
                    case 'h':
                        controlsPanel.classList.toggle('collapsed');
                        togglePanel.classList.toggle('panel-hidden');
                        break;
                }
            });
            
            // --- Mode Switching Logic ---
            const artisticModeBtn = document.getElementById('artisticModeBtn');
            const realisticModeBtn = document.getElementById('realisticModeBtn');
            const visualSettingsGroup = document.getElementById('visual-settings-group');

            function setMode(mode) {
                currentMode = mode;
                const isArtistic = mode === 'artistic';

                artisticModeBtn.classList.toggle('active', isArtistic);
                realisticModeBtn.classList.toggle('active', !isArtistic);
                
                // Disable visual settings in realistic mode
                document.getElementById('planetSize').disabled = !isArtistic;
                document.getElementById('orbitSize').disabled = !isArtistic;
                document.getElementById('sunIntensity').disabled = !isArtistic;
                
                // REALISM FIX: Adjust lighting for the selected mode
                if (isArtistic) {
                    sunLight.intensity = sunIntensity;
                    renderer.toneMappingExposure = 1.0;
                    sunLight.shadow.camera.far = 5000;
                    planets[0].material = sunPhongMaterial;
                } else { // Realistic Mode
                    sunLight.intensity = 200;
                    renderer.toneMappingExposure = 0.1;
                    sunLight.shadow.camera.far = 50000;
                    planets[0].material = new THREE.MeshBasicMaterial({ color: 0xffff00 });
                }
                sunLight.shadow.camera.updateProjectionMatrix();
                
                // Update scales and positions
                planets.forEach((planet, index) => {
                    const data = planetData[index];
                    const radius = isArtistic ? data.radius : data.realisticRadiusKM * REALISTIC_RADIUS_SCALE;
                    planet.scale.set(1,1,1);
                    planet.geometry.dispose();
                    planet.geometry = new THREE.SphereGeometry(radius, 64, 64);

                    if(data.moons){
                         planet.children.forEach(child => {
                            if (child.userData.isPlanet === false) { // It's a moon
                                const moonData = child.userData;
                                const moonRadius = isArtistic ? moonData.radius : moonData.realisticRadiusKM * REALISTIC_RADIUS_SCALE;
                                child.geometry.dispose();
                                child.geometry = new THREE.SphereGeometry(moonRadius, 32, 32);
                            }
                         });
                    }
                });

                orbits.forEach((orbit, index) => {
                    const data = planetData[index + 1];
                    const distance = isArtistic ? data.distance : data.realisticDistanceAU * REALISTIC_DISTANCE_SCALE;
                    orbit.geometry.dispose();
                    orbit.geometry = new THREE.RingGeometry(distance - 0.2, distance + 0.2, 128);
                });
                
                // Adjust camera for new scale
                camera.far = isArtistic ? 10000 : 80000;
                controls.maxDistance = isArtistic ? 500 : 40000;
                camera.updateProjectionMatrix();
                resetCameraView();
            }

            artisticModeBtn.addEventListener('click', () => setMode('artistic'));
            realisticModeBtn.addEventListener('click', () => setMode('realistic'));

            // --- Quick Navigation UI ---
            const navButtonsContainer = document.getElementById('nav-buttons');
            planetData.forEach((data, index) => {
                const navItem = document.createElement('div');
                navItem.className = 'nav-item';
                navItem.innerHTML = `<div class="nav-icon">${data.emoji}</div><div class="nav-name">${data.name}</div>`;
                navItem.addEventListener('click', () => {
                    const objectToFocus = planets[index];
                    focusOnObject(objectToFocus);
                    selectedObject = objectToFocus;
                    showObjectInfo(objectToFocus.userData);
                    if (currentView === 'planet') {
                        followingObject = objectToFocus;
                        updateStatusText();
                    }
                });
                navButtonsContainer.appendChild(navItem);
            });

            moonObjects.forEach(moon => {
                 const navItem = document.createElement('div');
                navItem.className = 'nav-item';
                navItem.innerHTML = `<div class="nav-icon">${moon.userData.emoji}</div><div class="nav-name">${moon.userData.name}</div>`;
                navItem.addEventListener('click', () => {
                    focusOnObject(moon);
                    selectedObject = moon;
                    showObjectInfo(moon.userData);
                    if (currentView === 'planet') {
                        followingObject = moon;
                        updateStatusText();
                    }
                });
                navButtonsContainer.appendChild(navItem);
            });


            // Start animation
            animate();
        });
    </script>
</body>
</html>
